---
trigger:
  branches:
    include:
      - master
pool:
  vmImage: ubuntu-latest
variables:
  node_version: 20.x
  sonar_project_key: user-managment_user-managment-fe
  sonar_org: user-managment
  sonar_token: a453abcbba74e1a12b5930bd8c2a8081869fb499
  SNYK_TOKEN: 32755ccb-60bf-4bb9-93c0-8c51fc2acd10
  SNYK_ORG: 0f0b457c-8795-47d9-a759-e2acd4723d21
steps:
  - checkout: self
    fetchDepth: 0
  - task: NodeTool@0
    inputs:
      versionSpec: $(node_version)
    displayName: Use Node.js $(node_version)
  - script: |
      cd api
      echo "🔍 Checking package-lock.json..."
      npm install --package-lock-only --ignore-scripts
      if ! git diff --quiet package-lock.json; then
        echo "⚠ package-lock.json out of sync, regenerating..."
        rm -f package-lock.json
        npm install
      fi
    displayName: Validate or regenerate lockfile
  - script: >
      cd api

      npm ci || (echo "⚠ npm ci failed, falling back to npm install" && npm install)
    displayName: Install dependencies
  - script: |
      cd api
      npm run lint || true
    displayName: Run linting (non-blocking)
  - task: Docker@2
    displayName: Docker Auth
    inputs:
      containerRegistry: docker-hub
      command: login
  - task: Docker@2
    displayName: Docker Image Build
    inputs:
      containerRegistry: 'docker-hub'
      repository: 'kanreddy/user-managment-app'
      command: 'build'
      Dockerfile: 'client/Dockerfile'
      buildContext: 'client/'
      tags: 'fe-1.0.0-$(Build.SourceVersion)'
  - task: Bash@3
    displayName: Snyk Install and Auth
    inputs:
      targetType: 'inline'
      script: |
        npm install -g snyk
        snyk auth $SNYK_TOKEN
  - task: Bash@3
    displayName: Snyk Monitor
    inputs:
      targetType: 'inline'
      script: |
        docker login -u kanreddy -p Docker@9133
        snyk test --docker kanreddy/user-managment-app/fe-1.0.0-$(Build.SourceVersion) --file=client/Dockerfile --severity-threshold=high --org=$SNYK_ORG
        snyk monitor --docker kanreddy/user-managment-app/fe-1.0.0-$(Build.SourceVersion)
  - task: Docker@2
    displayName: Docker Image Push
    inputs:
      containerRegistry: docker-hub
      repository: kanreddy/user-managment-app
      command: buildAndPush
      Dockerfile: client/Dockerfile
      tags: fe-1.0.0-$(Build.SourceVersion)

