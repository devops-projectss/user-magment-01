---
trigger:
  branches:
    include:
      - master
pool:
  name: Default
  demands:
    - agent.name -equals caching-pool
variables:
  - group: Snyk Variables
steps:
  - checkout: self
    fetchDepth: 0
  - task: NodeTool@0
    inputs:
      versionSpec: $(node_version)
    displayName: Use Node.js $(node_version)
  - script: |
      cd api
      echo "🔍 Checking package-lock.json..."
      npm install --package-lock-only --ignore-scripts
      if ! git diff --quiet package-lock.json; then
        echo "⚠ package-lock.json out of sync, regenerating..."
        rm -f package-lock.json
        npm install
      fi
    displayName: Validate or regenerate lockfile
  - script: >
      cd api

      npm ci || (echo "⚠ npm ci failed, falling back to npm install" && npm install)
    displayName: Install dependencies
  - script: |
      cd api
      npm run lint || true
    displayName: Run linting (non-blocking)
  - task: Docker@2
    displayName: Docker Auth
    inputs:
      containerRegistry: docker-hub
      command: login
  - task: Bash@3
    displayName: Pull Latest Image for Cache
    inputs:
        targetType: 'inline'
        script: |
          docker pull kanreddy/user-managment-app:latest || echo "No previous image found"

  - task: Docker@2
    displayName: Docker Image Build
    inputs:
      containerRegistry: 'docker-hub'
      repository: 'kanreddy/user-managment-app'
      command: 'build'
      Dockerfile: 'client/Dockerfile'
      buildContext: 'client/'
      tags: |
        fe-1.0.0-$(Build.SourceVersion)
        latest
      arguments: '--cache-from kanreddy/user-managment-app:latest'
      
  - task: Bash@3
    displayName: Snyk Install and Auth
    inputs:
      targetType: 'inline'
      script: |
        npm install -g snyk
        snyk auth $SNYK_TOKEN
  - task: Bash@3
    displayName: Snyk Monitor
    inputs:
      targetType: 'inline'
      script: |
        snyk test --docker kanreddy/user-managment-app:fe-1.0.0-$(Build.SourceVersion) --file=client/Dockerfile --severity-threshold=high --org=$SNYK_ORG
        snyk monitor --docker kanreddy/user-managment-app:fe-1.0.0-$(Build.SourceVersion)
  
  - task: Docker@2
    inputs:
      containerRegistry: 'docker-hub'
      repository: 'kanreddy/user-managment-app'
      command: 'push'
      tags: |
        fe-1.0.0-$(Build.SourceVersion)
        latest

 