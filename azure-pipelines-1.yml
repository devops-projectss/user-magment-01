---
trigger:
  branches:
    include:
      - main
pool:
  vmImage: ubuntu-latest
variables:
  node_version: 20.x
  sonar_project_key: user-managment_user-managment-fe
  sonar_org: user-managment
  sonar_token: 1282df0f8e319fc9cfd505e03f75fe116d0b9373
steps:
  - task: NodeTool@0
    inputs:
      versionSpec: $(node_version)
    displayName: Use Node.js $(node_version)
  - script: |
      cd api
      echo "🔍 Checking package-lock.json..."
      npm install --package-lock-only --ignore-scripts
      if ! git diff --quiet package-lock.json; then
        echo "⚠ package-lock.json out of sync, regenerating..."
        rm -f package-lock.json
        npm install
      fi
    displayName: Validate or regenerate lockfile
  - script: >
      cd api

      npm ci || (echo "⚠ npm ci failed, falling back to npm install" && npm install)
    displayName: Install dependencies
  - script: |
      cd api
      npm run lint || true
    displayName: Run linting (non-blocking)
  - task: SonarCloudPrepare@3
    inputs:
      SonarQube: 'SonarCloud'
      organization: 'user-managment'
      scannerMode: 'cli'
      configMode: 'manual'
      cliProjectKey: 'user-managment_user-managment-fe'  # MUST provide your project key
      cliProjectName: 'user-managment-fe'           # Friendly name
      extraProperties: |
        sonar.sources=api
        sonar.inclusions=**/*.js
  - task: SonarCloudAnalyze@3
    inputs:
      jdkversion: 'JAVA_HOME'
  - task: SonarCloudPublish@3
    inputs:
      pollingTimeoutSec: '300'
      
   
  
