---
trigger:
  branches:
    include:
      - master
pool:
  vmImage: ubuntu-latest
variables:
  node_version: 20.x
  sonar_project_key: "user-managment_user-managment-fe"
  sonar_org: "user-managment"
  sonar_token: "0068e447da437303bac6403a3d6cb66603f90706"
steps:
  - checkout: self
    fetchDepth: 0
  - task: NodeTool@0
    inputs:
      versionSpec: $(node_version)
    displayName: Use Node.js $(node_version)
  - script: |
      cd api
      echo "ðŸ” Checking package-lock.json..."
      npm install --package-lock-only --ignore-scripts
      if ! git diff --quiet package-lock.json; then
        echo "âš  package-lock.json out of sync, regenerating..."
        rm -f package-lock.json
        npm install
      fi
    displayName: Validate or regenerate lockfile
  - script: >
      cd api

      npm ci || (echo "âš  npm ci failed, falling back to npm install" && npm install)
    displayName: Install dependencies
  - script: |
      cd api
      npm run lint || true
    displayName: Run linting (non-blocking)
  - task: SonarCloudPrepare@3
    inputs:
      SonarQube: 'demo-srv'
      organization: 'user-managment'
      scannerMode: 'cli'
      configMode: 'manual'
      cliProjectKey: 'user-managment_user-managment-fe'
      cliProjectName: 'user-managment-fe'
      cliSources: '.'
      extraProperties: |
        sonar.sources=api
        sonar.token=$(sonar_token)
        sonar.inclusions=**/*.js
        sonar.branch.name=$(Build.SourceBranchName)
  - task: SonarCloudAnalyze@3
    inputs:
      jdkversion: 'JAVA_HOME'
  - task: SonarCloudPublish@3
      
   
  
