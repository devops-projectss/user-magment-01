trigger:
 branches:
   include:
     - main
pool:
  vmImage: ubuntu-latest
variables:
  node_version: '20.x'
  sonar_project_key: 'user-managment_user-managment-fe'
  sonar_org: 'user-managment'
  sonar_token: '1282df0f8e319fc9cfd505e03f75fe116d0b9373'
steps:
  - task: NodeTool@0
    inputs:
      versionSpec: $(node_version)
    displayName: 'Use Node.js $(node_version)'

  # 2. Validate / regenerate lockfile
  - script: |
      cd api
      echo "üîç Checking package-lock.json..."
      npm install --package-lock-only --ignore-scripts
      if ! git diff --quiet package-lock.json; then
        echo "‚ö† package-lock.json out of sync, regenerating..."
        rm -f package-lock.json
        npm install
      fi
    displayName: 'Validate or regenerate lockfile'

  # 3. Install dependencies cleanly
  - script: |
      cd api
      npm ci || (echo "‚ö† npm ci failed, falling back to npm install" && npm install)
    displayName: 'Install dependencies'

  # 4. Lint
  - script: |
      cd api
      npm run lint || true
    displayName: 'Run linting (non-blocking)'

  # 5. Run tests
  - script: |
      cd api
      npm test
    displayName: 'Run tests'

  # 6. Build backend
  - script: |
      cd api
      npm run build
    displayName: 'Build backend'
